{% assign collections = include.collections | split: "," %}
{% assign sort_fields = include.sort_fields | default: "released" | split: "," %}
{% assign progress_values = include.progress_values | default: "done" | split: "," %}

{% for collection_name in collections %}
  {% assign collection_items = site[collection_name] %}
  {% assign filtered_items = "" | split: "" %}

  {% comment %} Filter by allowed progress values {% endcomment %}
  {% for value in progress_values %}
    {% assign matching_items = collection_items | where: "progress", value %}
    {% if matching_items %}
      {% assign filtered_items = filtered_items | concat: matching_items %}
    {% endif %}
  {% endfor %}

  {% comment %} Build sort_key as simple string {% endcomment %}
  {% assign enriched_items = "" | split: "" %}

  {% for item in filtered_items %}
    {% assign sort_key = "" %}

    {% for field in sort_fields %}
      {% assign val = item[field] | default: "" %}
      {% assign val = val | append: "                    " %} {# pad with spaces for lex sort #}
      {% assign sort_key = sort_key | append: val %}
    {% endfor %}

    {% assign order_val = item.order | default: 5 %}
    {% if order_val < 10 %}
      {% assign order_val_str = "0" | append: order_val %}
    {% else %}
      {% assign order_val_str = order_val %}
    {% endif %}
    {% assign sort_key = sort_key | append: order_val_str %}

    {% assign item = item | merge: { "sort_key": sort_key } %}
    {% assign enriched_items = enriched_items | push: item %}
  {% endfor %}

  {% assign sorted_items = enriched_items | sort: "sort_key" %}

  <ul>
  {% for item in sorted_items %}
    <li>
      {% assign info_parts = "" | split: "" %}
      {% if item.class %}
        {% assign info_parts = info_parts | push: item.class | append: "-class" %}
      {% endif %}
      {% if item.released %}
        {% assign info_parts = info_parts | push: "released in " | append: item.released %}
      {% endif %}

      {% assign info_text = "" %}
      {% if info_parts.size > 0 %}
        {% assign info_text = info_parts | join: ", " %}
      {% endif %}

      {% assign display_text = item.title %}
      {% if info_text != "" %}
        {% assign display_text = display_text | append: " (" | append: info_text | append: ")" %}
      {% endif %}

      {# Debug: show sort_key #}
      {{ display_text }} [sort_key={{ item.sort_key }}] 

      {% if item.documented == "stub" %}
        <em>— documentation pending</em>
      {% else %}
        <a href="{{ item.url | relative_url }}">{{ display_text }}</a>
        {% if item.documented != "done" %} <em>— documentation in progress</em>{% endif %}
      {% endif %}
    </li>
  {% endfor %}
  </ul>
{% endfor %}
