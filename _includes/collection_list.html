{% comment %}
Include expects:
  - collections: comma-separated collection names (e.g., "home_computers,ibm_portables")
  - progress_values: comma-separated progress values to include (default: "done")
  - sort_fields: comma-separated fields to sort by (default: "released")
{% endcomment %}

{% assign collections = include.collections | split: "," %}
{% assign sort_fields = include.sort_fields | default: "released" | split: "," %}
{% assign progress_values = include.progress_values | default: "done" | split: "," %}

{% for collection_name in collections %}
  {% assign collection_items = site[collection_name] %}
  {% assign filtered_items = "" | split: "" %}

  {%- comment -%} Filter by allowed progress values {%- endcomment -%}
  {% for value in progress_values %}
    {% assign matching_items = collection_items | where: "progress", value %}
    {% if matching_items %}
      {% assign filtered_items = filtered_items | concat: matching_items %}
    {% endif %}
  {% endfor %}

  {%- comment -%}
    Build enriched array with sort_key for stable sorting.
    sort_key = concatenation of configured fields + normalized 'order' (default 5)
  {%- endcomment -%}

  {% assign enriched_items = "" | split: "" %}

  {% for item in filtered_items %}
    {% assign key_parts = "" | split: "" %}
    
    {% for field in sort_fields %}
      {% assign val = item[field] | default: "" %}
      {% assign val = val | append: "                    " %}
      {% assign key_parts = key_parts | push: val %}
    {% endfor %}

    {% assign order_val = item.order | default: 5 %}
    {% assign key_parts = key_parts | push: order_val %}

    {% assign sort_key = key_parts | join: "||" %}

    {%- comment -%} Store as JSON string (Jekyll 3.x compatible) {%- endcomment -%}
    {% assign enriched_item = '{"url":"'+ item.url +'","title":"'+ item.title +'","class":"'+ item.class +'","released":"'+ item.released +'","documented":"'+ item.documented +'","sort_key":"'+ sort_key +'"}' %}
    {% assign enriched_items = enriched_items | push: enriched_item %}
  {% endfor %}

  {%- comment -%} Sort items lexicographically by sort_key {%- endcomment -%}
  {% assign sorted_items = enriched_items | sort %}

  <ul>
  {% for item_json in sorted_items %}
    {% assign item = item_json | replace: '=>', ':' | jsonify | replace: '\\"', '"' | replace: '\\', '' | parse_json %}

    {% assign info_parts = "" | split: "" %}
    {% if item.class != "" %}
      {% assign class_str = item.class | append: "-class" %}
      {% assign info_parts = info_parts | push: class_str %}
    {% endif %}
    {% if item.released != "" %}
      {% assign released_str = "released in " | append: item.released %}
      {% assign info_parts = info_parts | push: released_str %}
    {% endif %}

    {% if info_parts.size > 0 %}
      {% assign info_text = info_parts | join: ", " %}
      {% assign display_text = item.title | append: " [" | append: item.sort_key | append: "] (" | append: info_text | append: ")" %}
    {% else %}
      {% assign display_text = item.title | append: " [" | append: item.sort_key | append: "]" %}
    {% endif %}

    {% if item.documented == "stub" %}
      {{ display_text }} <em>— documentation pending</em>
    {% else %}
      <a href="{{ item.url | relative_url }}">{{ display_text }}</a>
      {% if item.documented != "done" %} <em>— documentation in progress</em>{% endif %}
    {% endif %}
  {% endfor %}
  </ul>
{% endfor %}
